<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Augmented Reality AI Protocol Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js for potential future 3D/AR elements or visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-card {
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #0575E6, #021B79);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .ai-output {
            background-color: #eef2ff; /* Light blue/purple background */
            border-left: 4px solid #4f46e5; /* Indigo accent */
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        /* Loading spinner animation */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .input-section {
                padding: 1rem;
            }
            .output-section {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto container-card rounded-xl overflow-hidden">

        <!-- Header -->
        <header class="bg-indigo-600 p-6 text-white text-center rounded-t-xl">
            <h1 class="text-3xl font-extrabold mb-1">AR AI Protocol Generator</h1>
            <p class="text-indigo-200 text-sm">Design structured, actionable protocols using Google's Gemini Model and log them to the Activity Dashboard.</p>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-gray-200">

            <!-- 1. Input Section (2/3 width on desktop) -->
            <div class="lg:col-span-2 p-6 md:p-8 input-section">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Define Your Scenario</h2>

                <div class="mb-4 text-sm text-gray-600">
                    <p>User ID: <span id="userIdDisplay" class="font-mono text-xs bg-gray-100 p-1 rounded">...loading...</span></p>
                </div>

                <!-- Goal Input -->
                <div class="mb-6">
                    <label for="goalInput" class="block text-sm font-medium text-gray-700 mb-2">Primary Goal (What needs to be achieved?)</label>
                    <input type="text" id="goalInput" value="Diagnose engine fault in a specific model of industrial pump." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Assemble a new server rack; Calibrate a laser component;">
                </div>

                <!-- Context Input -->
                <div class="mb-6">
                    <label for="contextInput" class="block text-sm font-medium text-gray-700 mb-2">AR Context & Constraints (What resources are available?)</label>
                    <textarea id="contextInput" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Technician is wearing smart glasses; limited to hand tools; operation must not take longer than 30 minutes; pump model #45-B.">Technician is wearing smart glasses, has access to digital schematics, and must prioritize safety checks first.</textarea>
                </div>

                <!-- Generation Button -->
                <button id="generateButton" class="w-full btn-primary text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg flex items-center justify-center" onclick="generateProtocol()">
                    <span id="buttonText">Generate AR Protocol</span>
                    <span id="loadingSpinner" class="spinner hidden ml-3"></span>
                </button>

                <!-- Status Message -->
                <p id="statusMessage" class="mt-4 text-sm text-red-600 hidden"></p>

                <!-- Action Log Button -->
                <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-800">Action Plan</h3>
                    <button onclick="logProtocol()" id="logButton" class="bg-emerald-500 text-white font-medium py-2 px-4 rounded-lg shadow-md hover:bg-emerald-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Log to Activity Dashboard
                    </button>
                </div>

                <!-- Generated Protocol Output -->
                <div id="protocolOutput" class="ai-output mt-4 p-5 rounded-lg text-gray-800 text-sm hidden">
                    <!-- Protocol content goes here -->
                </div>
            </div>

            <!-- 2. Activity Dashboard (1/3 width on desktop) -->
            <div class="lg:col-span-1 p-6 md:p-8 output-section">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Activity Dashboard (Firestore)</h2>
                <div id="dashboardContent" class="space-y-4">
                    <!-- Logged protocols will be inserted here -->
                </div>
                <p id="dashboardMessage" class="text-gray-500 italic mt-4">Loading activity logs...</p>
            </div>

        </main>

    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Import necessary Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Setting Firebase log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (CRITICAL) ---
        // 1. API Key (MUST be your Gemini API Key)
        const apiKey = "AIzaSyCmi1dRvyb1_97VLYfj3T-V9tvojqSF8B8"; 
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

        // 2. Firebase Config and App ID (Using fallbacks for GitHub Pages compatibility)
        // NOTE: The dashboard will be disabled unless you replace 'null' with your OWN Firebase config object.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ar-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous';
        let currentProtocol = null;
        let isAuthReady = false;

        // --- UI ELEMENTS ---
        const protocolOutput = document.getElementById('protocolOutput');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');
        const logButton = document.getElementById('logButton');
        const dashboardContent = document.getElementById('dashboardContent');
        const dashboardMessage = document.getElementById('dashboardMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    // Start listening for dashboard updates
                    setupDashboardListener();
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in.");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        dashboardMessage.textContent = "Error initializing Firebase Auth. Check console for details.";
                        userIdDisplay.textContent = 'ERROR';
                        isAuthReady = true; // Still mark as ready to prevent infinite loading state
                    }
                }
            });
        } else {
            // Fallback for when no Firebase config is provided (e.g., on a basic local run or GitHub Pages without configuration)
            console.warn("Firebase configuration missing. Dashboard logging will be disabled.");
            dashboardMessage.textContent = "Dashboard is disabled. To enable, configure Firebase.";
            logButton.disabled = true;
            userIdDisplay.textContent = 'FIREBASE_DISABLED';
            isAuthReady = true;
        }


        // --- FIRESTORE DASHBOARD LOGIC ---

        function getProtocolsCollectionRef(uid) {
            // Private data path: /artifacts/{appId}/users/{userId}/protocols
            return collection(db, 'artifacts', appId, 'users', uid, 'protocols');
        }

        function setupDashboardListener() {
            if (!db || !isAuthReady) {
                console.warn("Firestore or Auth not ready, skipping listener setup.");
                return;
            }

            const protocolsQuery = query(getProtocolsCollectionRef(userId));

            onSnapshot(protocolsQuery, (snapshot) => {
                if (!isAuthReady) return; // Prevent callback execution before initial auth check

                const protocols = [];
                snapshot.forEach((doc) => {
                    protocols.push({ id: doc.id, ...doc.data() });
                });

                renderDashboard(protocols);
            }, (error) => {
                console.error("Error setting up dashboard listener:", error);
                dashboardMessage.textContent = "Error loading activity data.";
            });
        }

        function renderDashboard(protocols) {
            dashboardContent.innerHTML = '';
            protocols.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); // Sort newest first

            if (protocols.length === 0) {
                dashboardMessage.textContent = "No action plans logged yet.";
                return;
            }

            dashboardMessage.textContent = ''; // Clear loading message

            protocols.forEach(p => {
                const date = p.timestamp ? new Date(p.timestamp.toMillis()).toLocaleString() : 'N/A';
                const element = document.createElement('div');
                element.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition';
                element.innerHTML = `
                    <p class="text-xs font-semibold text-indigo-700">${date}</p>
                    <p class="text-sm font-medium text-gray-900 mt-1 truncate" title="${p.goal}">Goal: ${p.goal}</p>
                    <button class="text-xs text-indigo-600 mt-2 hover:text-indigo-800" onclick="viewProtocol('${p.id}')">View Protocol</button>
                `;
                dashboardContent.appendChild(element);
            });
        }

        window.viewProtocol = (id) => {
             // In a real app, you would fetch the full protocol. 
             // For this single-file example, we just log a message.
             console.log("Viewing full protocol for ID:", id);
             // You could implement a modal here to display the full text.
             alertModal('Protocol View', `In a full application, a modal would display the details for protocol ID: ${id}`);
        }

        function alertModal(title, message) {
            const existingModal = document.getElementById('customAlertModal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                        <p class="text-gray-700 text-sm mb-6">${message}</p>
                        <button onclick="document.getElementById('customAlertModal').remove()" class="w-full btn-primary text-white font-semibold py-2 rounded-lg">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        window.logProtocol = async () => {
            if (!currentProtocol || !db || !isAuthReady) {
                console.error("Cannot log protocol: Protocol not generated, Firestore disabled, or Auth not ready.");
                alertModal('Error', 'Cannot log protocol. Firestore is likely disabled because no configuration was found.');
                return;
            }

            try {
                // Ensure we only store essential, small, or serializable data
                const logData = {
                    goal: currentProtocol.goal,
                    context: currentProtocol.context,
                    protocol: currentProtocol.protocol, // Store the full text
                    timestamp: serverTimestamp(),
                    userId: userId,
                };

                await addDoc(getProtocolsCollectionRef(userId), logData);
                console.log("Protocol successfully logged to Firestore.");
                alertModal('Success!', 'The AR Protocol has been logged to your Activity Dashboard.');
                logButton.disabled = true; // Disable until a new protocol is generated

            } catch (error) {
                console.error("Error writing protocol to Firestore:", error);
                alertModal('Error', 'Failed to log the protocol. Check console for details.');
            }
        };

        // --- GEMINI API LOGIC ---

        // Simple exponential backoff retry mechanism for API calls
        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { // Rate limit
                        throw new Error("Rate limit exceeded. Retrying...");
                    }
                    if (!response.ok) {
                        // Throw error for other non-2xx status codes
                        let errorDetail = await response.text();
                        try {
                            const errorBody = JSON.parse(errorDetail);
                            errorDetail = JSON.stringify(errorBody);
                        } catch (e) {
                            // errorDetail is already text
                        }
                        throw new Error(`HTTP error! Status: ${response.status}. Details: ${errorDetail}`);
                    }
                    return response;
                } catch (error) {
                    // Only log error on the final retry attempt
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    // Exponential backoff
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function callGeminiAPI(prompt, systemInstruction) {
            if (!apiKey) {
                throw new Error("API Key is missing. Cannot call the model.");
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                // Use a strong, structured generation format
                generationConfig: {
                    temperature: 0.2,
                    topK: 40,
                },
            };

            const url = `${API_URL_BASE}?key=${apiKey}`;

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            };

            const response = await fetchWithRetry(url, options);
            const result = await response.json();

            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) {
                 // Check if there are block reasons or errors
                const reason = result.candidates?.[0]?.finishReason || 'Unknown';
                const message = result.error?.message || 'No text generated.';
                throw new Error(`API failed to generate text. Finish Reason: ${reason}. Error: ${message}`);
            }

            return text;
        }

        // --- MAIN APPLICATION LOGIC ---

        window.generateProtocol = async () => {
            const goal = document.getElementById('goalInput').value.trim();
            const context = document.getElementById('contextInput').value.trim();
            
            statusMessage.classList.add('hidden');
            
            if (!goal || !context) {
                statusMessage.textContent = 'Please fill out both the Goal and Context fields.';
                statusMessage.classList.remove('hidden');
                return;
            }

            // UI state: Start loading
            generateButton.disabled = true;
            logButton.disabled = true;
            buttonText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            protocolOutput.classList.add('hidden');
            
            currentProtocol = null;

            const systemInstruction = `You are an expert AI system for creating augmented reality (AR) guided technical protocols. Your response MUST be a single, structured, step-by-step list in Markdown format. The protocol must be safe, efficient, and directly address the user's goal while adhering to the specified constraints. Each step must be concise, actionable, and suitable for display in an AR headset. DO NOT include any introductory or concluding text, only the markdown list.`;
            
            const prompt = `Goal: ${goal}\nContext/Constraints: ${context}\n\nGenerate the complete AR-guided technical protocol with mandatory safety checks, using clear step-by-step instructions.`;

            try {
                const generatedText = await callGeminiAPI(prompt, systemInstruction);
                
                // Final cleaning and formatting
                const markdownContent = generatedText.startsWith('```markdown') 
                    ? generatedText.substring(13, generatedText.lastIndexOf('```'))
                    : generatedText;

                protocolOutput.innerHTML = formatProtocolForHTML(markdownContent);
                protocolOutput.classList.remove('hidden');

                // Store for logging
                currentProtocol = { goal, context, protocol: markdownContent };
                logButton.disabled = !firebaseConfig; // Only enable if Firebase config is present
                
            } catch (error) {
                console.error("AI Protocol Generation Error:", error);
                statusMessage.textContent = `AI Protocol Generation failed. Please try again. Error: ${error.message.split('. Details:')[0]}`;
                statusMessage.classList.remove('hidden');
            } finally {
                // UI state: Finish loading
                generateButton.disabled = false;
                buttonText.textContent = 'Generate AR Protocol';
                loadingSpinner.classList.add('hidden');
            }
        };
        
        // Simple Markdown-to-HTML formatting (converts markdown lists to HTML lists)
        function formatProtocolForHTML(markdown) {
            // Replace simple markdown list markers (* or -) with HTML list structure
            let html = markdown.replace(/^[\s]*[-*+]\s+(.*)/gm, (match, content) => {
                // Apply Tailwind classes for better list styling
                return `<li class="ml-4 pl-1 text-gray-700 mb-2 list-disc">${content.trim()}</li>`;
            });

            // Wrap in an unordered list if list items were found
            if (html.includes('<li')) {
                 html = `<ul class="list-inside p-0">${html}</ul>`;
            }
            
            // Basic bolding (for safety checks etc.)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 

            return html;
        }

    </script>
</body>
</html>
