<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Mastery Hub - Full Feature Set</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- CODE EDITOR THEME VARIABLES --- */
        :root {
            --color-bg-body: #1A1B26; /* Dark Navy */
            --color-bg-card: #282c34; /* Deep Charcoal */
            --color-text-light: #E0E6F0; /* Off-White Text */
            --color-accent-green: #00C853; /* Vibrant Green (freeCodeCamp inspired) */
            --color-accent-blue: #3E8EFF; /* Codecademy Blue */
            --color-output-bg: #1f232a; /* Slightly darker output box */
            --color-output-border: #00C853;
        }

        /* Base Body and Container Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-body);
            color: var(--color-text-light);
        }
        .container-card {
            background-color: var(--color-bg-card);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border: 1px solid #3c414a; /* Subtle border */
        }
        
        /* Primary Action Button (Vibrant Green) */
        .btn-primary {
            background-color: var(--color-accent-green);
            color: var(--color-bg-body); /* Dark text on bright button */
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            box-shadow: 0 0 15px rgba(0, 200, 83, 0.5); /* Glowing effect */
            transform: translateY(-2px);
        }
        
        /* AI Output Box Style */
        .ai-output {
            background-color: var(--color-output-bg); 
            border: 1px solid var(--color-output-border); 
            border-left: 4px solid var(--color-output-border);
            color: var(--color-text-light);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Input Fields */
        input[type="text"], textarea {
            background-color: #1f232a;
            border-color: #3c414a;
            color: var(--color-text-light);
        }
        input[type="text"]:focus, textarea:focus {
            border-color: var(--color-accent-blue);
            box-shadow: 0 0 0 1px var(--color-accent-blue);
        }

        /* Loading Spinner */
        .spinner {
            border-color: #3c414a;
            border-top-color: var(--color-accent-green);
        }

        /* Navigation Tab Styling */
        .tab-nav {
            background-color: #1f232a;
        }
        .tab-button {
            color: #9CA3AF;
            transition: color 0.2s, border-bottom 0.2s;
        }
        .tab-active {
            color: var(--color-accent-green);
            border-bottom: 3px solid var(--color-accent-green);
            font-weight: 600;
        }
        
        /* Dashboard Styling */
        .dashboard-item {
            background-color: #1f232a;
            border-color: #3c414a;
        }
        .dashboard-item:hover {
            background-color: #2c323d;
        }
        .text-indigo-700 { color: var(--color-accent-blue); }
        .text-gray-900 { color: var(--color-text-light); }
        .text-gray-600 { color: #A0AEC0; }
        .border-gray-200 { border-color: #3c414a; }

        /* Overriding specific Tailwind colors for the theme */
        .bg-indigo-600 { background-color: var(--color-accent-blue); }
        .text-indigo-200 { color: #BEE3F8; }
        .focus\:ring-indigo-500:focus { --tw-ring-color: var(--color-accent-blue); }
        .focus\:border-indigo-500:focus { border-color: var(--color-accent-blue); }
        .bg-emerald-500 { background-color: var(--color-accent-green); }
        .hover\:bg-emerald-600:hover { background-color: #00A343; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto container-card rounded-xl overflow-hidden">

        <!-- Header -->
        <header class="bg-indigo-600 p-6 text-white text-center rounded-t-xl">
            <h1 class="text-3xl font-extrabold mb-1">AR Mastery Hub</h1>
            <p class="text-indigo-200 text-sm">Central platform for protocol generation, code checking, and training assets.</p>
        </header>
        
        <!-- Navigation Tabs -->
        <nav class="border-b border-gray-700 shadow-sm sticky top-0 z-10 tab-nav">
            <div class="flex justify-start space-x-4 p-3 md:px-8">
                <button class="py-2 px-4 tab-button" data-tab="protocol">
                    AR Protocol Generator
                </button>
                <button class="py-2 px-4 tab-button" data-tab="checker">
                    Code Checker
                </button>
                <button class="py-2 px-4 tab-button" data-tab="hub">
                    Learning Hub
                </button>
                <button class="py-2 px-4 tab-button" data-tab="assets">
                    Denial Fix / Assets
                </button>
            </div>
        </nav>

        <!-- Main Content Area (Tab Panels) -->
        <div id="tabContent" class="p-6 md:p-8">
            
            <!-- 1. AR Protocol Generator Panel -->
            <div id="protocol" class="tab-panel grid grid-cols-1 lg:grid-cols-3 divide-y lg:divide-y-0 lg:divide-x divide-gray-700">
                <!-- Input Section (2/3 width on desktop) -->
                <div class="lg:col-span-2 p-0 md:pr-8 input-section">
                    <h2 class="text-2xl font-semibold mb-6">Define Your Scenario (AI Generation)</h2>

                    <div class="mb-4 text-sm text-gray-600">
                        <p>User ID: <span id="userIdDisplay" class="font-mono text-xs bg-gray-700 p-1 rounded text-white">...loading...</span></p>
                    </div>

                    <!-- Goal Input -->
                    <div class="mb-6">
                        <label for="goalInput" class="block text-sm font-medium text-gray-300 mb-2">Primary Goal (What needs to be achieved?)</label>
                        <input type="text" id="goalInput" value="Diagnose engine fault in a specific model of industrial pump." class="w-full p-3 border rounded-lg focus:ring-1" placeholder="e.g., Assemble a new server rack; Calibrate a laser component;">
                    </div>

                    <!-- Context Input -->
                    <div class="mb-6">
                        <label for="contextInput" class="block text-sm font-medium text-gray-300 mb-2">AR Context & Constraints (What resources are available?)</label>
                        <textarea id="contextInput" rows="4" class="w-full p-3 border rounded-lg focus:ring-1" placeholder="e.g., Technician is wearing smart glasses; limited to hand tools; operation must not take longer than 30 minutes; pump model #45-B.">Technician is wearing smart glasses, has access to digital schematics, and must prioritize safety checks first.</textarea>
                    </div>

                    <!-- Generation Button -->
                    <button id="generateButton" class="w-full btn-primary text-black font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg flex items-center justify-center" onclick="generateProtocol()">
                        <span id="buttonText">Generate AR Protocol</span>
                        <span id="loadingSpinner" class="spinner hidden ml-3"></span>
                    </button>

                    <!-- Status Message -->
                    <p id="statusMessage" class="mt-4 text-sm text-red-400 hidden"></p>

                    <!-- Action Log Button -->
                    <div class="mt-8 pt-6 border-t border-gray-700 flex justify-between items-center">
                        <h3 class="text-lg font-semibold">Action Plan</h3>
                        <button onclick="logProtocol()" id="logButton" class="bg-emerald-500 text-black font-medium py-2 px-4 rounded-lg shadow-md hover:bg-emerald-600 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Log to Activity Dashboard
                        </button>
                    </div>

                    <!-- Generated Protocol Output -->
                    <div id="protocolOutput" class="ai-output mt-4 p-5 rounded-lg text-sm hidden">
                        <!-- Protocol content goes here -->
                    </div>
                </div>

                <!-- Activity Dashboard (1/3 width on desktop) -->
                <div class="lg:col-span-1 p-0 pt-8 lg:pt-0 lg:pl-8 output-section">
                    <h2 class="text-2xl font-semibold mb-6 border-t lg:border-t-0 pt-8 lg:pt-0">Activity Dashboard (Firestore)</h2>
                    <div id="dashboardContent" class="space-y-4">
                        <!-- Logged protocols will be inserted here -->
                    </div>
                    <p id="dashboardMessage" class="text-gray-500 italic mt-4">Loading activity logs...</p>
                </div>
            </div>

            <!-- 2. Code Checker Panel -->
            <div id="checker" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-6">Code Checker & Review</h2>
                <p class="text-gray-400 mb-6">Paste your AR-specific code (e.g., Unity/C#, JavaScript, Python) here for an automated syntax and style review.</p>

                <textarea id="codeCheckerInput" rows="10" class="w-full p-4 border rounded-lg focus:ring-1 font-mono text-sm" placeholder="Paste your code here..."></textarea>
                
                <button onclick="checkCode()" class="w-full bg-purple-600 text-white font-bold py-3 px-4 mt-4 rounded-lg shadow-md hover:bg-purple-700 transition">
                    Run Code Check (Placeholder)
                </button>
                
                <div id="codeCheckerOutput" class="ai-output mt-6 p-5 rounded-lg text-sm hidden">
                    <h3 class="font-bold text-lg mb-2">Review Results:</h3>
                    <p>No issues found. Code is clean and optimized for AR performance.</p>
                </div>
            </div>

            <!-- 3. Learning Hub Panel -->
            <div id="hub" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-6">Learning Hub & Documentation</h2>
                <p class="text-gray-400 mb-6">Access guides, tutorials, and documentation for best practices in AR protocol design and development.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <a href="#" class="block p-6 rounded-xl hover:bg-gray-700 transition shadow-md border border-gray-700 dashboard-item">
                        <h3 class="text-xl font-bold text-green-400">Guide: Optimizing Protocols for Smart Glasses</h3>
                        <p class="text-sm text-gray-400 mt-2">Learn how to write steps that minimize head movement and eye strain.</p>
                    </a>
                    <a href="#" class="block p-6 rounded-xl hover:bg-gray-700 transition shadow-md border border-gray-700 dashboard-item">
                        <h3 class="text-xl font-bold text-green-400">Video: Firebase Setup for Real-Time Logging</h3>
                        <p class="text-sm text-gray-400 mt-2">Step-by-step video on enabling the Activity Dashboard with Firestore.</p>
                    </a>
                    <a href="#" class="block p-6 rounded-xl hover:bg-gray-700 transition shadow-md border border-gray-700 dashboard-item">
                        <h3 class="text-xl font-bold text-green-400">Checklist: Pre-Deployment AR Safety Review</h3>
                        <p class="text-sm text-gray-400 mt-2">Mandatory checks before deploying protocols to the field.</p>
                    </a>
                </div>
            </div>

            <!-- 4. Denial Fix / Assets Panel -->
            <div id="assets" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-6">Denial Fix & Training Assets ("Apples Section")</h2>
                <p class="text-gray-400 mb-6">This section provides troubleshooting workflows ("Denial Fix") and access to reusable training assets (e.g., 3D models, reference images, often referred to as the "Apples Section").</p>

                <!-- Denial Fix Card -->
                <div class="p-6 border border-red-500 rounded-xl mb-8 bg-red-900 bg-opacity-30">
                    <h3 class="text-xl font-bold text-red-400 mb-3">Workflow: Protocol Denial Fix</h3>
                    <p class="text-gray-300">If a generated protocol is rejected by a safety team, use this space to input their reason for denial to generate a compliant revision.</p>
                    <textarea rows="3" class="w-full p-2 mt-3 border border-red-500 rounded-lg bg-red-900 bg-opacity-20" placeholder="Enter denial reason here..."></textarea>
                    <button class="bg-red-600 text-white font-medium py-2 px-4 mt-3 rounded-lg hover:bg-red-700 transition">
                        Generate Revised Protocol (Placeholder)
                    </button>
                </div>
                
                <!-- Apples Section Asset List -->
                <h3 class="text-xl font-bold mb-4">Reusable Assets (Apples)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 rounded-lg text-sm border border-gray-700 dashboard-item">
                        <p class="font-medium text-green-400">Model: Industrial Pump (v2)</p>
                        <p class="text-xs text-gray-500">3D Asset - .gltf</p>
                    </div>
                    <div class="p-4 rounded-lg text-sm border border-gray-700 dashboard-item">
                        <p class="font-medium text-green-400">Schematic: Model #45-B Wiring</p>
                        <p class="text-xs text-gray-500">2D Asset - .pdf</p>
                    </div>
                    <div class="p-4 rounded-lg text-sm border border-gray-700 dashboard-item">
                        <p class="font-medium text-green-400">Checklist: Valve Calibration</p>
                        <p class="text-xs text-gray-500">Text Asset - .txt</p>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // Import necessary Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Setting Firebase log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL VARIABLES (CRITICAL) ---
        // 1. API Key (MUST be your Gemini API Key)
        const apiKey = "AIzaSyCmi1dRvyb1_97VLYfj3T-V9tvojqSF8B8"; 
        const API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

        // 2. Firebase Config and App ID (Using fallbacks for GitHub Pages compatibility)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-ar-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous';
        let currentProtocol = null;
        let isAuthReady = false;

        // --- UI ELEMENTS ---
        const protocolOutput = document.getElementById('protocolOutput');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const statusMessage = document.getElementById('statusMessage');
        const logButton = document.getElementById('logButton');
        const dashboardContent = document.getElementById('dashboardContent');
        const dashboardMessage = document.getElementById('dashboardMessage');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');

        // --- TAB MANAGEMENT ---
        function showTab(tabId) {
            tabPanels.forEach(panel => {
                panel.classList.add('hidden');
            });
            tabButtons.forEach(button => {
                button.classList.remove('tab-active');
            });

            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('tab-active');
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // Initialize with the Protocol Generator tab active
        showTab('protocol'); 

        // --- PLACEHOLDER FUNCTIONS FOR NEW TABS ---
        window.checkCode = () => {
            const input = document.getElementById('codeCheckerInput').value.trim();
            const output = document.getElementById('codeCheckerOutput');
            output.classList.remove('hidden');
            
            const outputElement = document.getElementById('codeCheckerOutput');
            const buttonElement = document.querySelector('#checker button');

            buttonElement.textContent = 'Checking Code...';
            buttonElement.disabled = true;

            setTimeout(() => {
                buttonElement.textContent = 'Run Code Check (Placeholder)';
                buttonElement.disabled = false;
                
                if (input.includes('unsafe') || input.includes('bug')) {
                    outputElement.innerHTML = `
                        <h3 class="font-bold text-lg mb-2 text-red-400">Review Results: CRITICAL ERRORS FOUND</h3>
                        <p>Potential issue with asynchronous AR scene updates detected. Review line 42 for unsafe state manipulation. Suggestion: Implement denial fix workflow to address security flags.</p>
                    `;
                } else if (input) {
                    outputElement.innerHTML = `
                        <h3 class="font-bold text-lg mb-2 text-green-400">Review Results: OPTIMIZED</h3>
                        <p>Code is clean, efficient, and follows AR development standards. Ready for deployment!</p>
                    `;
                } else {
                     outputElement.innerHTML = `
                        <h3 class="font-bold text-lg mb-2">Review Results:</h3>
                        <p>Please paste code into the text area to run the check.</p>
                    `;
                }
            }, 1500); // Simulate network delay
        }
        
        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 1. Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = userId;
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    setupDashboardListener();
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in.");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                        dashboardMessage.textContent = "Error initializing Firebase Auth. Check console for details.";
                        userIdDisplay.textContent = 'ERROR';
                        isAuthReady = true; 
                    }
                }
            });
        } else {
            console.warn("Firebase configuration missing. Dashboard logging will be disabled.");
            dashboardMessage.textContent = "Dashboard is disabled. To enable, configure Firebase.";
            logButton.disabled = true;
            userIdDisplay.textContent = 'FIREBASE_DISABLED';
            isAuthReady = true;
        }


        // --- FIRESTORE DASHBOARD LOGIC (Same as before) ---

        function getProtocolsCollectionRef(uid) {
            return collection(db, 'artifacts', appId, 'users', uid, 'protocols');
        }

        function setupDashboardListener() {
            if (!db || !isAuthReady) return;

            const protocolsQuery = query(getProtocolsCollectionRef(userId));

            onSnapshot(protocolsQuery, (snapshot) => {
                if (!isAuthReady) return; 

                const protocols = [];
                snapshot.forEach((doc) => {
                    protocols.push({ id: doc.id, ...doc.data() });
                });

                renderDashboard(protocols);
            }, (error) => {
                console.error("Error setting up dashboard listener:", error);
                dashboardMessage.textContent = "Error loading activity data.";
            });
        }

        function renderDashboard(protocols) {
            dashboardContent.innerHTML = '';
            protocols.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); 

            if (protocols.length === 0) {
                dashboardMessage.textContent = "No action plans logged yet.";
                return;
            }

            dashboardMessage.textContent = ''; 

            protocols.forEach(p => {
                const date = p.timestamp ? new Date(p.timestamp.toMillis()).toLocaleString() : 'N/A';
                const element = document.createElement('div');
                element.className = 'dashboard-item p-4 rounded-lg border hover:shadow-lg transition';
                element.innerHTML = `
                    <p class="text-xs font-semibold text-green-400">${date}</p>
                    <p class="text-sm font-medium text-white mt-1 truncate" title="${p.goal}">Goal: ${p.goal}</p>
                    <button class="text-xs text-blue-400 mt-2 hover:text-blue-200" onclick="alertModal('Protocol Details', 'Goal: ${p.goal.replace(/'/g, '\\\'')}<br>Context: ${p.context.replace(/'/g, '\\\'')}<br>---<br>Protocol: ${p.protocol.replace(/\n/g, '<br>').replace(/'/g, '\\\'')}')">View Protocol</button>
                `;
                dashboardContent.appendChild(element);
            });
        }

        window.logProtocol = async () => {
            if (!currentProtocol || !db || !isAuthReady) {
                console.error("Cannot log protocol: Protocol not generated, Firestore disabled, or Auth not ready.");
                alertModal('Error', 'Cannot log protocol. Firestore is likely disabled because no configuration was found.');
                return;
            }

            try {
                const logData = {
                    goal: currentProtocol.goal,
                    context: currentProtocol.context,
                    protocol: currentProtocol.protocol,
                    timestamp: serverTimestamp(),
                    userId: userId,
                };

                await addDoc(getProtocolsCollectionRef(userId), logData);
                console.log("Protocol successfully logged to Firestore.");
                alertModal('Success!', 'The AR Protocol has been logged to your Activity Dashboard.');
                logButton.disabled = true; 

            } catch (error) {
                console.error("Error writing protocol to Firestore:", error);
                alertModal('Error', 'Failed to log the protocol. Check console for details.');
            }
        };
        
        // Modal and UI helpers (same as before)
        function alertModal(title, message) {
            const existingModal = document.getElementById('customAlertModal');
            if (existingModal) existingModal.remove();

            const modalHtml = `
                <div id="customAlertModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50">
                    <div class="bg-gray-800 rounded-xl shadow-2xl max-w-sm w-full p-6 text-white border border-gray-700">
                        <h3 class="text-xl font-bold text-green-400 mb-4">${title}</h3>
                        <p class="text-gray-300 text-sm mb-6">${message}</p>
                        <button onclick="document.getElementById('customAlertModal').remove()" class="w-full btn-primary text-black font-semibold py-2 rounded-lg">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // --- GEMINI API LOGIC (Same as before) ---

        async function fetchWithRetry(url, options, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { throw new Error("Rate limit exceeded. Retrying..."); }
                    if (!response.ok) {
                        let errorDetail = await response.text();
                        try {
                            const errorBody = JSON.parse(errorDetail);
                            errorDetail = JSON.stringify(errorBody);
                        } catch (e) {}
                        throw new Error(`HTTP error! Status: ${response.status}. Details: ${errorDetail}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) { throw error; }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function callGeminiAPI(prompt, systemInstruction) {
            if (!apiKey) { throw new Error("API Key is missing. Cannot call the model."); }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { temperature: 0.2, topK: 40 },
            };

            const url = `${API_URL_BASE}?key=${apiKey}`;

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            };

            const response = await fetchWithRetry(url, options);
            const result = await response.json();

            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) {
                const reason = result.candidates?.[0]?.finishReason || 'Unknown';
                const message = result.error?.message || 'No text generated.';
                throw new Error(`API failed to generate text. Finish Reason: ${reason}. Error: ${message}`);
            }

            return text;
        }

        // --- MAIN APPLICATION LOGIC (Same as before) ---

        window.generateProtocol = async () => {
            const goal = document.getElementById('goalInput').value.trim();
            const context = document.getElementById('contextInput').value.trim();
            
            statusMessage.classList.add('hidden');
            
            if (!goal || !context) {
                statusMessage.textContent = 'Please fill out both the Goal and Context fields.';
                statusMessage.classList.remove('hidden');
                return;
            }

            // UI state: Start loading
            generateButton.disabled = true;
            logButton.disabled = true;
            buttonText.textContent = 'Generating...';
            loadingSpinner.classList.remove('hidden');
            protocolOutput.classList.add('hidden');
            
            currentProtocol = null;

            const systemInstruction = `You are an expert AI system for creating augmented reality (AR) guided technical protocols. Your response MUST be a single, structured, step-by-step list in Markdown format. The protocol must be safe, efficient, and directly address the user's goal while adhering to the specified constraints. Each step must be concise, actionable, and suitable for display in an AR headset. DO NOT include any introductory or concluding text, only the markdown list.`;
            
            const prompt = `Goal: ${goal}\nContext/Constraints: ${context}\n\nGenerate the complete AR-guided technical protocol with mandatory safety checks, using clear step-by-step instructions.`;

            try {
                const generatedText = await callGeminiAPI(prompt, systemInstruction);
                
                const markdownContent = generatedText.startsWith('```markdown') 
                    ? generatedText.substring(13, generatedText.lastIndexOf('```'))
                    : generatedText;

                protocolOutput.innerHTML = formatProtocolForHTML(markdownContent);
                protocolOutput.classList.remove('hidden');

                // Store for logging
                currentProtocol = { goal, context, protocol: markdownContent };
                logButton.disabled = !firebaseConfig; // Only enable if Firebase config is present
                
            } catch (error) {
                console.error("AI Protocol Generation Error:", error);
                statusMessage.textContent = `AI Protocol Generation failed. Please try again. Error: ${error.message.split('. Details:')[0]}`;
                statusMessage.classList.remove('hidden');
            } finally {
                // UI state: Finish loading
                generateButton.disabled = false;
                buttonText.textContent = 'Generate AR Protocol';
                loadingSpinner.classList.add('hidden');
            }
        };
        
        function formatProtocolForHTML(markdown) {
            let html = markdown.replace(/^[\s]*[-*+]\s+(.*)/gm, (match, content) => {
                return `<li class="ml-4 pl-1 text-gray-300 mb-2 list-disc">${content.trim()}</li>`;
            });

            if (html.includes('<li')) {
                 html = `<ul class="list-inside p-0">${html}</ul>`;
            }
            
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-green-400">$1</strong>'); 

            return html;
        }

    </script>
</body>
</html>
